<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PERC - Participants</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --sidebar-width: 280px;
        --sidebar-collapsed: 72px;
        --primary-blue: #0047ab;
        --secondary-blue: #003380;
        --accent-orange: #ff4500;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f5f7fa;
        overflow-x: hidden;
      }

      /* ==================== SIDEBAR PRINCIPALE ==================== */

      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        width: var(--sidebar-width);
        background: linear-gradient(
          180deg,
          var(--primary-blue) 0%,
          var(--secondary-blue) 100%
        );
        color: white;
        display: flex;
        flex-direction: column;
        z-index: 1000;
        transition: width 0.3s ease;
        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.1);
      }

      .sidebar.collapsed {
        width: var(--sidebar-collapsed);
      }

      /* ==================== HEADER AVEC LOGO ==================== */

      .sidebar-header {
        padding: 24px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        display: flex;
        align-items: center;
        gap: 14px;
        flex-shrink: 0;
        transition: all 0.3s ease;
      }

      .sidebar.collapsed .sidebar-header {
        padding: 24px 12px;
        justify-content: center;
      }

      .sidebar-logo {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
        transition: all 0.3s ease;
      }

      .sidebar.collapsed .sidebar-logo {
        width: 44px;
        height: 44px;
      }

      .sidebar-logo img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .sidebar-brand {
        flex: 1;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .sidebar.collapsed .sidebar-brand {
        opacity: 0;
        width: 0;
      }

      .sidebar-brand-name {
        font-size: 1.05rem;
        font-weight: 700;
        color: white;
        line-height: 1.3;
        white-space: nowrap;
        letter-spacing: -0.01em;
      }

      .sidebar-brand-tagline {
        font-size: 0.75rem;
        color: hsl(0, 100%, 47%);
        font-weight: 500;
        white-space: nowrap;
        margin-top: 2px;
      }

      /* ==================== BOUTON TOGGLE ==================== */

      .sidebar-toggle {
        position: absolute;
        top: 32px;
        right: -14px;
        width: 28px;
        height: 28px;
        background: white;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.2s ease;
        z-index: 10;
      }

      .sidebar-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .sidebar-toggle i {
        color: var(--primary-blue);
        font-size: 0.9rem;
        transition: transform 0.3s ease;
      }

      .sidebar.collapsed .sidebar-toggle i {
        transform: rotate(180deg);
      }

      /* ==================== NAVIGATION ==================== */

      .sidebar-nav {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 12px 8px;
      }

      .sidebar-nav::-webkit-scrollbar {
        width: 4px;
      }

      .sidebar-nav::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }

      .sidebar-nav::-webkit-scrollbar-track {
        background: transparent;
      }

      /* ==================== SECTIONS ==================== */

      .menu-section {
        margin-bottom: 24px;
      }

      .menu-section-title {
        padding: 0 16px 8px 16px;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        color: rgba(255, 255, 255, 0.5);
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .sidebar.collapsed .menu-section-title {
        opacity: 0;
        height: 0;
        padding: 0;
        margin: 0;
      }

      /* ==================== MENU ITEMS (STYLE CLAUDE) ==================== */

      .menu-item {
        position: relative;
        margin: 2px 0;
      }

      .menu-item a {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 11px 16px;
        color: rgba(255, 255, 255, 0.85);
        text-decoration: none;
        border-radius: 10px;
        transition: all 0.2s ease;
        position: relative;
      }

      .sidebar.collapsed .menu-item a {
        justify-content: center;
        padding: 11px 8px;
        gap: 0;
      }

      /* Hover subtil comme Claude */
      .menu-item a:hover {
        background: rgba(255, 255, 255, 0.12);
        color: white;
      }

      /* √âtat actif avec barre lat√©rale */
      .menu-item a.active {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        font-weight: 500;
      }

      .menu-item a.active::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 24px;
        width: 3px;
        background: var(--accent-orange);
        border-radius: 0 2px 2px 0;
      }

      /* Ic√¥nes centr√©es proprement */
      .menu-icon {
        font-size: 1.25rem;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .menu-text {
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.3s ease;
        letter-spacing: -0.01em;
      }

      .sidebar.collapsed .menu-text {
        opacity: 0;
        width: 0;
      }

      /* Badge discret */
      .menu-badge {
        margin-left: auto;
        background: var(--accent-orange);
        color: white;
        font-size: 0.65rem;
        font-weight: 700;
        padding: 3px 7px;
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      .sidebar.collapsed .menu-badge {
        opacity: 0;
        width: 0;
      }

      /* ==================== FOOTER ADMIN ==================== */

      .sidebar-footer {
        flex-shrink: 0;
        padding: 16px 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.12);
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .user-profile:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      .sidebar.collapsed .user-profile {
        justify-content: center;
        padding: 10px 8px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent-orange), #ff6347);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1rem;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .user-info {
        flex: 1;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .sidebar.collapsed .user-info {
        opacity: 0;
        width: 0;
      }

      .user-name {
        font-size: 0.88rem;
        font-weight: 600;
        color: white;
        white-space: nowrap;
        line-height: 1.3;
      }

      .user-role {
        font-size: 0.72rem;
        color: rgba(255, 255, 255, 0.65);
        white-space: nowrap;
      }

      /* ==================== TOOLTIPS ==================== */

      .menu-item::after {
        content: attr(data-tooltip);
        position: absolute;
        left: calc(100% + 12px);
        top: 50%;
        transform: translateY(-50%) translateX(-8px);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: all 0.2s ease;
        z-index: 1000;
      }

      .sidebar.collapsed .menu-item:hover::after {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
      }

      /* ==================== MAIN CONTENT ==================== */

      .main-content {
        margin-left: var(--sidebar-width);
        padding: 28px 32px;
        transition: margin-left 0.3s ease;
        min-height: 100vh;
        max-width: 1600px;
      }

      .sidebar.collapsed ~ .main-content {
        margin-left: var(--sidebar-collapsed);
      }

      /* ==================== RESPONSIVE ==================== */

      @media (max-width: 1200px) {
        .main-content {
          max-width: 100%;
          padding: 24px;
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          width: var(--sidebar-collapsed);
        }

        .sidebar-brand,
        .menu-text,
        .user-info,
        .menu-badge,
        .menu-section-title {
          opacity: 0;
          width: 0;
        }

        .sidebar-header {
          justify-content: center;
        }

        .main-content {
          margin-left: var(--sidebar-collapsed);
          padding: 20px;
        }

        .sidebar-toggle {
          display: none;
        }
      }

      .card-custom {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }

      /* Stats mini bar */
      .stats-mini {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-mini-card {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .stat-mini-card:nth-child(2) {
        background: linear-gradient(135deg, var(--accent-orange) 0%, #ff6347 100%);
      }

      .stat-mini-card:nth-child(3) {
        background: linear-gradient(135deg, var(--primary-blue) 0%, #0066cc 100%);
      }

      .stat-mini-card:nth-child(4) {
        background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--primary-blue) 100%);
      }

      .stat-mini-label {
        font-size: 0.85rem;
        opacity: 0.9;
      }

      .stat-mini-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-top: 5px;
      }

      /* Search area */
      .search-area {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .search-box {
        flex: 1;
        position: relative;
      }

      .search-box input {
        width: 100%;
        padding: 12px 45px 12px 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 1rem;
      }

      .search-box i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
      }

      .btn-advanced {
        padding: 12px 20px;
        background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-advanced:hover {
        background: var(--secondary-blue);
      }

      /* Advanced search panel */
      .advanced-search {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        display: none;
      }

      .advanced-search.show {
        display: block;
      }

      /* Table */
      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
      }

      thead th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border: none;
        cursor: pointer;
        user-select: none;
        position: relative;
      }

      thead th:hover {
        background: #e9ecef;
      }

      .sort-icon {
        position: absolute;
        right: 10px;
        opacity: 0.3;
      }

      .sort-icon.active {
        opacity: 1;
      }

      tbody tr {
        background: white;
        transition: all 0.3s;
        cursor: pointer;
      }

      tbody tr:hover {
        background: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      tbody td {
        padding: 15px;
        border: none;
      }

      /* Badge solde */
      .badge-solde {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.95rem;
      }

      .badge-high {
        background: #d4edda;
        color: #155724;
      }

      .badge-medium {
        background: #fff3cd;
        color: #856404;
      }

      .badge-low {
        background: #f8d7da;
        color: #721c24;
      }

      /* Pagination */
      .pagination-area {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .pagination-controls button {
        padding: 8px 15px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 5px;
        margin: 0 2px;
        transition: all 0.3s;
      }

      .pagination-controls button:hover {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
      }

      .pagination-controls button.active {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
      }

      .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .per-page select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
      }

      /* Modal */
      .modal-header {
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
      }

      .info-group {
        margin-bottom: 15px;
      }

      .info-label {
        font-weight: 600;
        color: #666;
        font-size: 0.9rem;
      }

      .info-value {
        font-size: 1.1rem;
        color: var(--secondary-blue);
      }

      .btn-edit-solde {
        background: linear-gradient(135deg, var(--primary-blue), var(--accent-orange));
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-edit-solde:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 71, 171, 0.3);
      }

      /* Bootstrap overrides */
      .btn-primary {
        background-color: var(--primary-blue) !important;
        border-color: var(--primary-blue) !important;
      }

      .btn-primary:hover {
        background-color: var(--secondary-blue) !important;
        border-color: var(--secondary-blue) !important;
      }

      .text-primary {
        color: var(--primary-blue) !important;
      }

      .spinner-border.text-primary {
        border-color: var(--primary-blue);
        border-right-color: transparent;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 40px;
      }

      .spinner-border {
        width: 3rem;
        height: 3rem;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar Moderne -->
    <div class="sidebar" id="sidebar">
      <!-- Toggle Button -->
      <button
        class="sidebar-toggle"
        onclick="toggleSidebar()"
        aria-label="Toggle sidebar"
      >
        <i class="bi bi-chevron-left"></i>
      </button>

      <!-- Header avec Logo -->
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="LOGO-MDS2.png" alt="Mutuelle des Douanes" />
        </div>
        <div class="sidebar-brand">
          <div class="sidebar-brand-name">Mutuelle des Douanes</div>
          <div class="sidebar-brand-tagline">
            La solidarit√© pour mieux servir
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="sidebar-nav">
        <!-- Section Principale -->
        <div class="menu-section">
          <div class="menu-section-title">Principal</div>

          <div class="menu-item" data-tooltip="Tableau de bord">
            <a href="admin-dashboard.html">
              <i class="bi bi-speedometer2 menu-icon"></i>
              <span class="menu-text">Tableau de bord</span>
            </a>
          </div>

          <div class="menu-item" data-tooltip="Participants">
            <a href="participants.html" class="active">
              <i class="bi bi-people menu-icon"></i>
              <span class="menu-text">Participants</span>
            </a>
          </div>

          <div class="menu-item" data-tooltip="Import CGF">
            <a
              href="admin-dashboard.html"
              onclick="event.preventDefault(); window.location.href='admin-dashboard.html'; setTimeout(() => showSection('import'), 100)"
            >
              <i class="bi bi-cloud-upload menu-icon"></i>
              <span class="menu-text">Import CGF</span>
              <span class="menu-badge">New</span>
            </a>
          </div>
        </div>

        <!-- Section Donn√©es -->
        <div class="menu-section">
          <div class="menu-section-title">Donn√©es</div>

          <div class="menu-item" data-tooltip="Historique">
            <a
              href="admin-dashboard.html"
              onclick="event.preventDefault(); window.location.href='admin-dashboard.html'; setTimeout(() => showSection('history'), 100)"
            >
              <i class="bi bi-clock-history menu-icon"></i>
              <span class="menu-text">Historique</span>
            </a>
          </div>

          <div class="menu-item" data-tooltip="Statistiques">
            <a
              href="admin-dashboard.html"
              onclick="event.preventDefault(); window.location.href='admin-dashboard.html'; setTimeout(() => showSection('stats'), 100)"
            >
              <i class="bi bi-bar-chart-line menu-icon"></i>
              <span class="menu-text">Statistiques</span>
            </a>
          </div>
        </div>

        <!-- Section Syst√®me -->
        <div class="menu-section">
          <div class="menu-section-title">Syst√®me</div>

          <div class="menu-item" data-tooltip="D√©connexion">
            <a href="#" onclick="logout()">
              <i class="bi bi-box-arrow-right menu-icon"></i>
              <span class="menu-text">D√©connexion</span>
            </a>
          </div>
        </div>
      </nav>

      <!-- Footer User -->
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar">A</div>
          <div class="user-info">
            <div class="user-name">Administrateur</div>
            <div class="user-role">Gestionnaire PERC</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Stats Mini Bar -->
      <div class="stats-mini" id="statsMini">
        <div class="stat-mini-card">
          <div class="stat-mini-label">Total participants</div>
          <div class="stat-mini-value">-</div>
        </div>
        <div class="stat-mini-card">
          <div class="stat-mini-label">Solde moyen</div>
          <div class="stat-mini-value">-</div>
        </div>
        <div class="stat-mini-card">
          <div class="stat-mini-label">Solde total PERC</div>
          <div class="stat-mini-value">-</div>
        </div>
        <div class="stat-mini-card">
          <div class="stat-mini-label">Dernier import</div>
          <div class="stat-mini-value">-</div>
        </div>
      </div>

      <div class="card-custom">
        <h3><i class="bi bi-people"></i> Liste des participants</h3>
        <p class="text-muted mb-4">Rechercher et g√©rer les participants PERC</p>

        <!-- Search Area -->
        <div class="search-area">
          <div class="search-box">
            <input
              type="text"
              id="searchInput"
              placeholder="üîç Recherche intelligente : matricule, nom, compte CGF..."
              oninput="handleSearch()"
            />
            <i class="bi bi-search"></i>
          </div>
          <button class="btn-advanced" onclick="toggleAdvancedSearch()">
            <i class="bi bi-funnel"></i> Recherche avanc√©e
          </button>
        </div>

        <!-- Advanced Search -->
        <div class="advanced-search" id="advancedSearch">
          <div class="row">
            <div class="col-md-4">
              <label class="form-label">Compte CGF</label>
              <input
                type="text"
                class="form-control"
                id="filterCGF"
                placeholder="Ex: 0182000401"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Solde minimum</label>
              <input
                type="number"
                class="form-control"
                id="filterMinSolde"
                placeholder="Ex: 500000"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Solde maximum</label>
              <input
                type="number"
                class="form-control"
                id="filterMaxSolde"
                placeholder="Ex: 2000000"
              />
            </div>
          </div>
          <div class="mt-3">
            <button class="btn btn-primary" onclick="applyAdvancedSearch()">
              <i class="bi bi-check"></i> Appliquer
            </button>
            <button class="btn btn-secondary" onclick="resetAdvancedSearch()">
              <i class="bi bi-x"></i> R√©initialiser
            </button>
          </div>
        </div>

        <!-- Table -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th onclick="sortTable('matricule')">
                  Matricule
                  <i
                    class="bi bi-arrow-down-up sort-icon"
                    data-col="matricule"
                  ></i>
                </th>
                <th onclick="sortTable('nom')">
                  Nom
                  <i class="bi bi-arrow-down-up sort-icon" data-col="nom"></i>
                </th>
                <th onclick="sortTable('compte_cgf')">
                  Compte CGF
                  <i
                    class="bi bi-arrow-down-up sort-icon"
                    data-col="compte_cgf"
                  ></i>
                </th>
                <th onclick="sortTable('solde_actuel')">
                  Solde
                  <i
                    class="bi bi-arrow-down-up sort-icon"
                    data-col="solde_actuel"
                  ></i>
                </th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="participantsTable">
              <tr>
                <td colspan="5" class="loading">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="mt-3">Chargement des participants...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-area">
          <div class="per-page">
            Afficher
            <select id="perPageSelect" onchange="changePerPage()">
              <option value="20">20</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
            par page
          </div>
          <div class="pagination-controls" id="paginationControls">
            <!-- G√©n√©r√© par JS -->
          </div>
          <div class="pagination-info" id="paginationInfo">
            <!-- Affichage 1-50 sur 1893 -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal D√©tails -->
    <div class="modal fade" id="participantModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-person-circle"></i> D√©tails du participant
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="participantDetails"></div>
        </div>
      </div>
    </div>

    <!-- Modal Modifier Solde -->
    <div class="modal fade" id="editSoldeModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-cash-coin"></i> Modifier le solde
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Solde actuel</label>
              <input
                type="text"
                class="form-control"
                id="currentSolde"
                readonly
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Nouveau solde *</label>
              <input
                type="number"
                class="form-control"
                id="newSolde"
                placeholder="Entrez le nouveau solde"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Raison de la modification *</label>
              <textarea
                class="form-control"
                id="raisonModif"
                rows="3"
                placeholder="Expliquez pourquoi..."
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Annuler
            </button>
            <button type="button" class="btn btn-primary" onclick="saveSolde()">
              Enregistrer
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = "http://localhost:3000/api/stats";
      let allParticipants = [];
      let filteredParticipants = [];
      let currentMatricule = "";
      let currentPage = 1;
      let perPage = 50;
      let sortColumn = null;
      let sortDirection = "asc";

      // Normaliser texte (enlever accents)
      function normalizeText(text) {
        return text
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase();
      }

      // Formater nombre avec s√©parateur et sans d√©cimales
      function formatNumber(num) {
        return Math.round(num).toLocaleString("fr-FR");
      }

      // Charger stats mini
      async function loadMiniStats() {
        try {
          const token = localStorage.getItem("percAdminToken");
          const response = await fetch(`${API_BASE}/dashboard`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const result = await response.json();

          if (result.success) {
            const stats = result.data;
            const cards = document.querySelectorAll(
              ".stat-mini-card .stat-mini-value"
            );
            cards[0].textContent = formatNumber(stats.participants_actifs);

            const avg =
              stats.participants_actifs > 0
                ? stats.solde_total / stats.participants_actifs
                : 0;
            cards[1].textContent = formatNumber(avg) + " CFA";

            const total = stats.solde_total / 1000000000;
            cards[2].textContent = total.toFixed(2) + " Mds CFA";

            cards[3].textContent = "Aujourd'hui";
          }
        } catch (error) {
          console.error("Erreur stats:", error);
        }
      }

      // Charger participants
      async function loadParticipants() {
        try {
          const token = localStorage.getItem("percAdminToken");
          const response = await fetch(`${API_BASE}/participants?limit=10000`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          const result = await response.json();

          if (result.success) {
            allParticipants = result.data;
            filteredParticipants = [...allParticipants];
            displayPage();
          }
        } catch (error) {
          console.error("Erreur:", error);
          document.getElementById("participantsTable").innerHTML =
            '<tr><td colspan="5" class="text-center text-danger">Erreur de chargement</td></tr>';
        }
      }

      // Recherche intelligente
      function handleSearch() {
        const search = normalizeText(
          document.getElementById("searchInput").value
        );

        if (!search) {
          filteredParticipants = [...allParticipants];
        } else {
          filteredParticipants = allParticipants.filter(
            (p) =>
              normalizeText(p.matricule).includes(search) ||
              normalizeText(p.nom).includes(search) ||
              normalizeText(p.compte_cgf || "").includes(search)
          );
        }

        currentPage = 1;
        displayPage();
      }

      // Toggle recherche avanc√©e
      function toggleAdvancedSearch() {
        document.getElementById("advancedSearch").classList.toggle("show");
      }

      // Appliquer recherche avanc√©e
      function applyAdvancedSearch() {
        const cgf = document.getElementById("filterCGF").value;
        const minSolde =
          parseFloat(document.getElementById("filterMinSolde").value) || 0;
        const maxSolde =
          parseFloat(document.getElementById("filterMaxSolde").value) ||
          Infinity;

        filteredParticipants = allParticipants.filter((p) => {
          const matchCGF = !cgf || (p.compte_cgf || "").includes(cgf);
          const matchSolde =
            (p.solde_actuel || 0) >= minSolde &&
            (p.solde_actuel || 0) <= maxSolde;
          return matchCGF && matchSolde;
        });

        currentPage = 1;
        displayPage();
      }

      // Reset recherche avanc√©e
      function resetAdvancedSearch() {
        document.getElementById("filterCGF").value = "";
        document.getElementById("filterMinSolde").value = "";
        document.getElementById("filterMaxSolde").value = "";
        filteredParticipants = [...allParticipants];
        currentPage = 1;
        displayPage();
      }

      // Tri
      function sortTable(column) {
        if (sortColumn === column) {
          if (sortDirection === "asc") {
            sortDirection = "desc";
          } else if (sortDirection === "desc") {
            sortColumn = null;
            sortDirection = "asc";
            filteredParticipants = [...allParticipants];
            displayPage();
            updateSortIcons();
            return;
          }
        } else {
          sortColumn = column;
          sortDirection = "asc";
        }

        filteredParticipants.sort((a, b) => {
          let valA = a[column] || "";
          let valB = b[column] || "";

          if (column === "solde_actuel") {
            valA = parseFloat(valA) || 0;
            valB = parseFloat(valB) || 0;
          } else {
            valA = normalizeText(String(valA));
            valB = normalizeText(String(valB));
          }

          if (sortDirection === "asc") {
            return valA > valB ? 1 : -1;
          } else {
            return valA < valB ? 1 : -1;
          }
        });

        displayPage();
        updateSortIcons();
      }

      function updateSortIcons() {
        document.querySelectorAll(".sort-icon").forEach((icon) => {
          icon.classList.remove("active");
          icon.className = "bi bi-arrow-down-up sort-icon";
        });

        if (sortColumn) {
          const icon = document.querySelector(
            `.sort-icon[data-col="${sortColumn}"]`
          );
          icon.classList.add("active");
          icon.className =
            sortDirection === "asc"
              ? "bi bi-arrow-up sort-icon active"
              : "bi bi-arrow-down sort-icon active";
        }
      }

      // Afficher page
      function displayPage() {
        const start = (currentPage - 1) * perPage;
        const end = start + perPage;
        const pageData = filteredParticipants.slice(start, end);

        const tbody = document.getElementById("participantsTable");

        if (pageData.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center">Aucun participant trouv√©</td></tr>';
          return;
        }

        tbody.innerHTML = pageData
          .map((p) => {
            const solde = p.solde_actuel || 0;
            let badgeClass = "badge-low";
            if (solde >= 1000000) badgeClass = "badge-high";
            else if (solde >= 500000) badgeClass = "badge-medium";

            return `
                    <tr onclick="viewParticipant('${p.matricule}')">
                        <td>${p.matricule}</td>
                        <td>${p.nom}</td>
                        <td>${p.compte_cgf || "-"}</td>
                        <td><span class="badge-solde ${badgeClass}">${formatNumber(
              solde
            )} CFA</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); viewParticipant('${
                              p.matricule
                            }')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
          })
          .join("");

        updatePagination();
      }

      // Pagination
      function updatePagination() {
        const totalPages = Math.ceil(filteredParticipants.length / perPage);
        const controls = document.getElementById("paginationControls");
        const info = document.getElementById("paginationInfo");

        const start = (currentPage - 1) * perPage + 1;
        const end = Math.min(
          currentPage * perPage,
          filteredParticipants.length
        );
        info.textContent = `Affichage ${start}-${end} sur ${filteredParticipants.length}`;

        let html = "";
        html += `<button onclick="goToPage(1)" ${
          currentPage === 1 ? "disabled" : ""
        }>¬´</button>`;
        html += `<button onclick="goToPage(${currentPage - 1})" ${
          currentPage === 1 ? "disabled" : ""
        }>‚Äπ</button>`;

        for (
          let i = Math.max(1, currentPage - 2);
          i <= Math.min(totalPages, currentPage + 2);
          i++
        ) {
          html += `<button onclick="goToPage(${i})" class="${
            i === currentPage ? "active" : ""
          }">${i}</button>`;
        }

        html += `<button onclick="goToPage(${currentPage + 1})" ${
          currentPage === totalPages ? "disabled" : ""
        }>‚Ä∫</button>`;
        html += `<button onclick="goToPage(${totalPages})" ${
          currentPage === totalPages ? "disabled" : ""
        }>¬ª</button>`;

        controls.innerHTML = html;
      }

      function goToPage(page) {
        currentPage = page;
        displayPage();
      }

      function changePerPage() {
        perPage = parseInt(document.getElementById("perPageSelect").value);
        currentPage = 1;
        displayPage();
      }

      // Voir d√©tails
      async function viewParticipant(matricule) {
        try {
          currentMatricule = matricule;
          const token = localStorage.getItem("percAdminToken");
          const response = await fetch(`${API_BASE}/participant/${matricule}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          const result = await response.json();

          if (result.success) {
            const p = result.data;
            document.getElementById("participantDetails").innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-group">
                                    <div class="info-label">Matricule</div>
                                    <div class="info-value">${p.matricule}</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Nom complet</div>
                                    <div class="info-value">${p.nom}</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Email</div>
                                    <div class="info-value">${
                                      p.email || "-"
                                    }</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">T√©l√©phone</div>
                                    <div class="info-value">${
                                      p.telephone || "-"
                                    }</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-group">
                                    <div class="info-label">Compte CGF</div>
                                    <div class="info-value">${
                                      p.compte_cgf || "-"
                                    }</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Solde actuel</div>
                                    <div class="info-value" style="font-size: 1.5rem; color: #0047ab; font-weight: 700;">
                                        ${formatNumber(p.solde_actuel || 0)} CFA
                                    </div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Nombre de contributions</div>
                                    <div class="info-value">${
                                      p.nb_contributions || 0
                                    }</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Derni√®re contribution</div>
                                    <div class="info-value">${
                                      p.derniere_contribution
                                        ? new Date(
                                            p.derniere_contribution
                                          ).toLocaleDateString("fr-FR")
                                        : "-"
                                    }</div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <button class="btn-edit-solde" onclick="openEditSolde(${
                          p.solde_actuel || 0
                        })">
                            <i class="bi bi-pencil"></i> Modifier le solde
                        </button>
                    `;

            new bootstrap.Modal(
              document.getElementById("participantModal")
            ).show();
          }
        } catch (error) {
          console.error("Erreur:", error);
          alert("Erreur lors du chargement");
        }
      }

      // Modifier solde
      function openEditSolde(currentSolde) {
        document.getElementById("currentSolde").value =
          formatNumber(currentSolde) + " CFA";
        document.getElementById("newSolde").value = Math.round(currentSolde);
        document.getElementById("raisonModif").value = "";

        bootstrap.Modal.getInstance(
          document.getElementById("participantModal")
        ).hide();
        new bootstrap.Modal(document.getElementById("editSoldeModal")).show();
      }

      async function saveSolde() {
        const newSolde = document.getElementById("newSolde").value;
        const raison = document.getElementById("raisonModif").value;

        if (!newSolde || !raison) {
          alert("Veuillez remplir tous les champs");
          return;
        }

        try {
          const token = localStorage.getItem("percAdminToken");
          const response = await fetch(
            `${API_BASE}/participant/${currentMatricule}/solde`,
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                nouveau_solde: parseFloat(newSolde),
                raison: raison,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            alert("Solde modifi√© avec succ√®s !");
            bootstrap.Modal.getInstance(
              document.getElementById("editSoldeModal")
            ).hide();
            loadParticipants();
            loadMiniStats();
          } else {
            alert("Erreur: " + result.message);
          }
        } catch (error) {
          console.error("Erreur:", error);
          alert("Erreur lors de la modification");
        }
      }

      // Toggle Sidebar
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("collapsed");
        localStorage.setItem(
          "sidebarCollapsed",
          sidebar.classList.contains("collapsed")
        );
      }

      // Logout
      function logout() {
        if (confirm("√ätes-vous s√ªr de vouloir vous d√©connecter ?")) {
          localStorage.removeItem("percAdminToken");
          localStorage.removeItem("sidebarCollapsed");
          window.location.href = "admin-login.html";
        }
      }

      // Init
      window.addEventListener("DOMContentLoaded", () => {
        if (!localStorage.getItem("percAdminToken")) {
          window.location.href = "admin-login.html";
          return;
        }

        // Restaurer √©tat sidebar
        const isCollapsed = localStorage.getItem("sidebarCollapsed") === "true";
        if (isCollapsed) {
          document.getElementById("sidebar").classList.add("collapsed");
        }

        loadMiniStats();
        loadParticipants();
      });
    </script>
  </body>
</html>
