<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PERC - Participants</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
      }

      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        width: 260px;
        background: linear-gradient(180deg, #2c3e50, #34495e);
        color: white;
        padding: 20px 0;
        z-index: 1000;
        overflow-y: auto;
      }

      .sidebar-logo {
        padding: 0 20px;
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .sidebar-menu a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.3s;
      }

      .sidebar-menu a:hover,
      .sidebar-menu a.active {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .main-content {
        margin-left: 260px;
        padding: 20px;
      }

      .card-custom {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }

      /* Stats mini bar */
      .stats-mini {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-mini-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .stat-mini-card:nth-child(2) {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .stat-mini-card:nth-child(3) {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      .stat-mini-card:nth-child(4) {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      }

      .stat-mini-label {
        font-size: 0.85rem;
        opacity: 0.9;
      }

      .stat-mini-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-top: 5px;
      }

      /* Search area */
      .search-area {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .search-box {
        flex: 1;
        position: relative;
      }

      .search-box input {
        width: 100%;
        padding: 12px 45px 12px 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 1rem;
      }

      .search-box i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
      }

      .btn-advanced {
        padding: 12px 20px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-advanced:hover {
        background: #2980b9;
      }

      /* Advanced search panel */
      .advanced-search {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        display: none;
      }

      .advanced-search.show {
        display: block;
      }

      /* Table */
      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
      }

      thead th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border: none;
        cursor: pointer;
        user-select: none;
        position: relative;
      }

      thead th:hover {
        background: #e9ecef;
      }

      .sort-icon {
        position: absolute;
        right: 10px;
        opacity: 0.3;
      }

      .sort-icon.active {
        opacity: 1;
      }

      tbody tr {
        background: white;
        transition: all 0.3s;
        cursor: pointer;
      }

      tbody tr:hover {
        background: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      tbody td {
        padding: 15px;
        border: none;
      }

      /* Badge solde */
      .badge-solde {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.95rem;
      }

      .badge-high {
        background: #d4edda;
        color: #155724;
      }

      .badge-medium {
        background: #fff3cd;
        color: #856404;
      }

      .badge-low {
        background: #f8d7da;
        color: #721c24;
      }

      /* Pagination */
      .pagination-area {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .pagination-controls button {
        padding: 8px 15px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 5px;
        margin: 0 2px;
        transition: all 0.3s;
      }

      .pagination-controls button:hover {
        background: #3498db;
        color: white;
        border-color: #3498db;
      }

      .pagination-controls button.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
      }

      .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .per-page select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
      }

      /* Modal */
      .modal-header {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: white;
      }

      .info-group {
        margin-bottom: 15px;
      }

      .info-label {
        font-weight: 600;
        color: #666;
        font-size: 0.9rem;
      }

      .info-value {
        font-size: 1.1rem;
        color: #2c3e50;
      }

      .btn-edit-solde {
        background: linear-gradient(135deg, #3498db, #2ecc71);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 40px;
      }

      .spinner-border {
        width: 3rem;
        height: 3rem;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-logo">
        <i class="bi bi-shield-check"></i> PERC Admin
      </div>
      <div class="sidebar-menu">
        <a href="admin-dashboard.html"
          ><i class="bi bi-speedometer2"></i> Tableau de bord</a
        >
        <a href="participants.html" class="active"
          ><i class="bi bi-people"></i> Participants</a
        >
        <a href="admin-dashboard.html#import"
          ><i class="bi bi-upload"></i> Import CGF</a
        >
        <a href="admin-dashboard.html#historique"
          ><i class="bi bi-clock-history"></i> Historique</a
        >
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Stats Mini Bar -->
      <div class="stats-mini" id="statsMini">
        <div class="stat-mini-card">
          <div class="stat-mini-label">Total participants</div>
          <div class="stat-mini-value">-</div>
        </div>
        <div class="stat-mini-card">
          <div class="stat-mini-label">Solde moyen</div>
          <div class="stat-mini-value">-</div>
        </div>
        <div class="stat-mini-card">
          <div class="stat-mini-label">Solde total PERC</div>
          <div class="stat-mini-value">-</div>
        </div>
        <div class="stat-mini-card">
          <div class="stat-mini-label">Dernier import</div>
          <div class="stat-mini-value">-</div>
        </div>
      </div>

      <div class="card-custom">
        <h3><i class="bi bi-people"></i> Liste des participants</h3>
        <p class="text-muted mb-4">Rechercher et g√©rer les participants PERC</p>

        <!-- Search Area -->
        <div class="search-area">
          <div class="search-box">
            <input
              type="text"
              id="searchInput"
              placeholder="üîç Recherche intelligente : matricule, nom, compte CGF..."
              oninput="handleSearch()"
            />
            <i class="bi bi-search"></i>
          </div>
          <button class="btn-advanced" onclick="toggleAdvancedSearch()">
            <i class="bi bi-funnel"></i> Recherche avanc√©e
          </button>
        </div>

        <!-- Advanced Search -->
        <div class="advanced-search" id="advancedSearch">
          <div class="row">
            <div class="col-md-4">
              <label class="form-label">Compte CGF</label>
              <input
                type="text"
                class="form-control"
                id="filterCGF"
                placeholder="Ex: 0182000401"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Solde minimum</label>
              <input
                type="number"
                class="form-control"
                id="filterMinSolde"
                placeholder="Ex: 500000"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Solde maximum</label>
              <input
                type="number"
                class="form-control"
                id="filterMaxSolde"
                placeholder="Ex: 2000000"
              />
            </div>
          </div>
          <div class="mt-3">
            <button class="btn btn-primary" onclick="applyAdvancedSearch()">
              <i class="bi bi-check"></i> Appliquer
            </button>
            <button class="btn btn-secondary" onclick="resetAdvancedSearch()">
              <i class="bi bi-x"></i> R√©initialiser
            </button>
          </div>
        </div>

        <!-- Table -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th onclick="sortTable('matricule')">
                  Matricule
                  <i
                    class="bi bi-arrow-down-up sort-icon"
                    data-col="matricule"
                  ></i>
                </th>
                <th onclick="sortTable('nom')">
                  Nom
                  <i class="bi bi-arrow-down-up sort-icon" data-col="nom"></i>
                </th>
                <th onclick="sortTable('compte_cgf')">
                  Compte CGF
                  <i
                    class="bi bi-arrow-down-up sort-icon"
                    data-col="compte_cgf"
                  ></i>
                </th>
                <th onclick="sortTable('solde_actuel')">
                  Solde
                  <i
                    class="bi bi-arrow-down-up sort-icon"
                    data-col="solde_actuel"
                  ></i>
                </th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="participantsTable">
              <tr>
                <td colspan="5" class="loading">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="mt-3">Chargement des participants...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-area">
          <div class="per-page">
            Afficher
            <select id="perPageSelect" onchange="changePerPage()">
              <option value="20">20</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
            par page
          </div>
          <div class="pagination-controls" id="paginationControls">
            <!-- G√©n√©r√© par JS -->
          </div>
          <div class="pagination-info" id="paginationInfo">
            <!-- Affichage 1-50 sur 1893 -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal D√©tails -->
    <div class="modal fade" id="participantModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-person-circle"></i> D√©tails du participant
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="participantDetails"></div>
        </div>
      </div>
    </div>

    <!-- Modal Modifier Solde -->
    <div class="modal fade" id="editSoldeModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-cash-coin"></i> Modifier le solde
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Solde actuel</label>
              <input
                type="text"
                class="form-control"
                id="currentSolde"
                readonly
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Nouveau solde *</label>
              <input
                type="number"
                class="form-control"
                id="newSolde"
                placeholder="Entrez le nouveau solde"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Raison de la modification *</label>
              <textarea
                class="form-control"
                id="raisonModif"
                rows="3"
                placeholder="Expliquez pourquoi..."
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Annuler
            </button>
            <button type="button" class="btn btn-primary" onclick="saveSolde()">
              Enregistrer
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = "http://localhost:3000/api/stats";
      let allParticipants = [];
      let filteredParticipants = [];
      let currentMatricule = "";
      let currentPage = 1;
      let perPage = 50;
      let sortColumn = null;
      let sortDirection = "asc";

      // Normaliser texte (enlever accents)
      function normalizeText(text) {
        return text
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase();
      }

      // Charger stats mini
      async function loadMiniStats() {
        try {
          const token = localStorage.getItem("percAdminToken");
          const response = await fetch(`${API_BASE}/dashboard`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const result = await response.json();

          if (result.success) {
            const stats = result.data;
            const cards = document.querySelectorAll(
              ".stat-mini-card .stat-mini-value"
            );
            cards[0].textContent =
              stats.participants_actifs.toLocaleString("fr-FR");

            const avg =
              stats.participants_actifs > 0
                ? stats.solde_total / stats.participants_actifs
                : 0;
            cards[1].textContent =
              Math.round(avg).toLocaleString("fr-FR") + " CFA";

            const total = stats.solde_total / 1000000000;
            cards[2].textContent = total.toFixed(2) + " Mds CFA";

            cards[3].textContent = "Aujourd'hui";
          }
        } catch (error) {
          console.error("Erreur stats:", error);
        }
      }

      // Charger participants
      async function loadParticipants() {
        try {
          const token = localStorage.getItem("percAdminToken");
          const response = await fetch(`${API_BASE}/participants?limit=10000`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          const result = await response.json();

          if (result.success) {
            allParticipants = result.data;
            filteredParticipants = [...allParticipants];
            displayPage();
          }
        } catch (error) {
          console.error("Erreur:", error);
          document.getElementById("participantsTable").innerHTML =
            '<tr><td colspan="5" class="text-center text-danger">Erreur de chargement</td></tr>';
        }
      }

      // Recherche intelligente
      function handleSearch() {
        const search = normalizeText(
          document.getElementById("searchInput").value
        );

        if (!search) {
          filteredParticipants = [...allParticipants];
        } else {
          filteredParticipants = allParticipants.filter(
            (p) =>
              normalizeText(p.matricule).includes(search) ||
              normalizeText(p.nom).includes(search) ||
              normalizeText(p.compte_cgf || "").includes(search)
          );
        }

        currentPage = 1;
        displayPage();
      }

      // Toggle recherche avanc√©e
      function toggleAdvancedSearch() {
        document.getElementById("advancedSearch").classList.toggle("show");
      }

      // Appliquer recherche avanc√©e
      function applyAdvancedSearch() {
        const cgf = document.getElementById("filterCGF").value;
        const minSolde =
          parseFloat(document.getElementById("filterMinSolde").value) || 0;
        const maxSolde =
          parseFloat(document.getElementById("filterMaxSolde").value) ||
          Infinity;

        filteredParticipants = allParticipants.filter((p) => {
          const matchCGF = !cgf || (p.compte_cgf || "").includes(cgf);
          const matchSolde =
            (p.solde_actuel || 0) >= minSolde &&
            (p.solde_actuel || 0) <= maxSolde;
          return matchCGF && matchSolde;
        });

        currentPage = 1;
        displayPage();
      }

      // Reset recherche avanc√©e
      function resetAdvancedSearch() {
        document.getElementById("filterCGF").value = "";
        document.getElementById("filterMinSolde").value = "";
        document.getElementById("filterMaxSolde").value = "";
        filteredParticipants = [...allParticipants];
        currentPage = 1;
        displayPage();
      }

      // Tri
      function sortTable(column) {
        if (sortColumn === column) {
          if (sortDirection === "asc") {
            sortDirection = "desc";
          } else if (sortDirection === "desc") {
            sortColumn = null;
            sortDirection = "asc";
            filteredParticipants = [...allParticipants];
            displayPage();
            updateSortIcons();
            return;
          }
        } else {
          sortColumn = column;
          sortDirection = "asc";
        }

        filteredParticipants.sort((a, b) => {
          let valA = a[column] || "";
          let valB = b[column] || "";

          if (column === "solde_actuel") {
            valA = parseFloat(valA) || 0;
            valB = parseFloat(valB) || 0;
          } else {
            valA = normalizeText(String(valA));
            valB = normalizeText(String(valB));
          }

          if (sortDirection === "asc") {
            return valA > valB ? 1 : -1;
          } else {
            return valA < valB ? 1 : -1;
          }
        });

        displayPage();
        updateSortIcons();
      }

      function updateSortIcons() {
        document.querySelectorAll(".sort-icon").forEach((icon) => {
          icon.classList.remove("active");
          icon.className = "bi bi-arrow-down-up sort-icon";
        });

        if (sortColumn) {
          const icon = document.querySelector(
            `.sort-icon[data-col="${sortColumn}"]`
          );
          icon.classList.add("active");
          icon.className =
            sortDirection === "asc"
              ? "bi bi-arrow-up sort-icon active"
              : "bi bi-arrow-down sort-icon active";
        }
      }

      // Afficher page
      function displayPage() {
        const start = (currentPage - 1) * perPage;
        const end = start + perPage;
        const pageData = filteredParticipants.slice(start, end);

        const tbody = document.getElementById("participantsTable");

        if (pageData.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center">Aucun participant trouv√©</td></tr>';
          return;
        }

        tbody.innerHTML = pageData
          .map((p) => {
            const solde = p.solde_actuel || 0;
            let badgeClass = "badge-low";
            if (solde >= 1000000) badgeClass = "badge-high";
            else if (solde >= 500000) badgeClass = "badge-medium";

            return `
                    <tr onclick="viewParticipant('${p.matricule}')">
                        <td>${p.matricule}</td>
                        <td>${p.nom}</td>
                        <td>${p.compte_cgf || "-"}</td>
                        <td><span class="badge-solde ${badgeClass}">${solde.toLocaleString(
              "fr-FR"
            )} CFA</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); viewParticipant('${
                              p.matricule
                            }')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
          })
          .join("");

        updatePagination();
      }

      // Pagination
      function updatePagination() {
        const totalPages = Math.ceil(filteredParticipants.length / perPage);
        const controls = document.getElementById("paginationControls");
        const info = document.getElementById("paginationInfo");

        const start = (currentPage - 1) * perPage + 1;
        const end = Math.min(
          currentPage * perPage,
          filteredParticipants.length
        );
        info.textContent = `Affichage ${start}-${end} sur ${filteredParticipants.length}`;

        let html = "";
        html += `<button onclick="goToPage(1)" ${
          currentPage === 1 ? "disabled" : ""
        }>¬´</button>`;
        html += `<button onclick="goToPage(${currentPage - 1})" ${
          currentPage === 1 ? "disabled" : ""
        }>‚Äπ</button>`;

        for (
          let i = Math.max(1, currentPage - 2);
          i <= Math.min(totalPages, currentPage + 2);
          i++
        ) {
          html += `<button onclick="goToPage(${i})" class="${
            i === currentPage ? "active" : ""
          }">${i}</button>`;
        }

        html += `<button onclick="goToPage(${currentPage + 1})" ${
          currentPage === totalPages ? "disabled" : ""
        }>‚Ä∫</button>`;
        html += `<button onclick="goToPage(${totalPages})" ${
          currentPage === totalPages ? "disabled" : ""
        }>¬ª</button>`;

        controls.innerHTML = html;
      }

      function goToPage(page) {
        currentPage = page;
        displayPage();
      }

      function changePerPage() {
        perPage = parseInt(document.getElementById("perPageSelect").value);
        currentPage = 1;
        displayPage();
      }

      // Voir d√©tails
      async function viewParticipant(matricule) {
        try {
          currentMatricule = matricule;
          const token = localStorage.getItem("percAdminToken");
          const response = await fetch(`${API_BASE}/participant/${matricule}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          const result = await response.json();

          if (result.success) {
            const p = result.data;
            document.getElementById("participantDetails").innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-group">
                                    <div class="info-label">Matricule</div>
                                    <div class="info-value">${p.matricule}</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Nom complet</div>
                                    <div class="info-value">${p.nom}</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Email</div>
                                    <div class="info-value">${
                                      p.email || "-"
                                    }</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">T√©l√©phone</div>
                                    <div class="info-value">${
                                      p.telephone || "-"
                                    }</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-group">
                                    <div class="info-label">Compte CGF</div>
                                    <div class="info-value">${
                                      p.compte_cgf || "-"
                                    }</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Solde actuel</div>
                                    <div class="info-value" style="font-size: 1.5rem; color: #27ae60;">
                                        ${(p.solde_actuel || 0).toLocaleString(
                                          "fr-FR"
                                        )} CFA
                                    </div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Nombre de contributions</div>
                                    <div class="info-value">${
                                      p.nb_contributions || 0
                                    }</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Derni√®re contribution</div>
                                    <div class="info-value">${
                                      p.derniere_contribution
                                        ? new Date(
                                            p.derniere_contribution
                                          ).toLocaleDateString("fr-FR")
                                        : "-"
                                    }</div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <button class="btn-edit-solde" onclick="openEditSolde(${
                          p.solde_actuel || 0
                        })">
                            <i class="bi bi-pencil"></i> Modifier le solde
                        </button>
                    `;

            new bootstrap.Modal(
              document.getElementById("participantModal")
            ).show();
          }
        } catch (error) {
          console.error("Erreur:", error);
          alert("Erreur lors du chargement");
        }
      }

      // Modifier solde
      function openEditSolde(currentSolde) {
        document.getElementById("currentSolde").value =
          currentSolde.toLocaleString("fr-FR") + " CFA";
        document.getElementById("newSolde").value = currentSolde;
        document.getElementById("raisonModif").value = "";

        bootstrap.Modal.getInstance(
          document.getElementById("participantModal")
        ).hide();
        new bootstrap.Modal(document.getElementById("editSoldeModal")).show();
      }

      async function saveSolde() {
        const newSolde = document.getElementById("newSolde").value;
        const raison = document.getElementById("raisonModif").value;

        if (!newSolde || !raison) {
          alert("Veuillez remplir tous les champs");
          return;
        }

        try {
          const token = localStorage.getItem("percAdminToken");
          const response = await fetch(
            `${API_BASE}/participant/${currentMatricule}/solde`,
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                nouveau_solde: parseFloat(newSolde),
                raison: raison,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            alert("Solde modifi√© avec succ√®s !");
            bootstrap.Modal.getInstance(
              document.getElementById("editSoldeModal")
            ).hide();
            loadParticipants();
            loadMiniStats();
          } else {
            alert("Erreur: " + result.message);
          }
        } catch (error) {
          console.error("Erreur:", error);
          alert("Erreur lors de la modification");
        }
      }

      // Init
      window.addEventListener("DOMContentLoaded", () => {
        if (!localStorage.getItem("percAdminToken")) {
          window.location.href = "admin-login.html";
          return;
        }

        loadMiniStats();
        loadParticipants();
      });
    </script>
  </body>
</html>
